<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Estoque</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'bootstrap.css' %}">
    </head>
    {% include "header.html" %}
    <body>
        <div class="container my-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-center">Gerenciamento de Estoque</h1>
                <a href="/admin/fabrica/produto/add"
                   class="btn btn-primary btn-lg"
                   id="addProdutoButton">Adicionar Novo Produto</a>
                <a href="/admin/fabrica/materiaprima/add"
                   class="btn btn-primary btn-lg"
                   id="addMateriaPrimaButton"
                   style="display: none">Adicionar Nova Matéria-Prima</a>
            </div>
            <div class="mb-4">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="toggleProdutos">
                    <label class="form-check-label" for="toggleProdutos">Mostrar Produtos</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="toggleMateriasPrimas">
                    <label class="form-check-label" for="toggleMateriasPrimas">Mostrar Matérias-Primas</label>
                </div>
            </div>
            <div id="produtosSection">
                {% if produtos_baixo_estoque %}
                    <div class="alert alert-danger alert-dismissible fade show"
                         id="estoque-baixo-alerta"
                         role="alert">
                        <strong>Atenção!</strong> Alguns produtos estão com estoque baixo:
                        <ul>
                            {% for produto in produtos_baixo_estoque %}
                                <li>{{ produto.nome }} - Quantidade disponível: {{ produto.estoque_disponivel }}</li>
                            {% endfor %}
                        </ul>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="alert"
                                aria-label="Close"></button>
                    </div>
                {% endif %}
                <form id="produto-form"
                      method="GET"
                      action=""
                      class="mb-3 border p-3 rounded bg-secondary text-white">
                    <h2>Buscar Produtos</h2>
                    <div class="row">
                        <div class="col-md-6">{{ produto_form.id_produto.label_tag }} {{ produto_form.id_produto }}</div>
                        <div class="col-md-6">{{ produto_form.nome.label_tag }} {{ produto_form.nome }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ produto_form.estoque_disponivel_min.label_tag }} {{ produto_form.estoque_disponivel_min }}
                        </div>
                        <div class="col-md-6">
                            {{ produto_form.estoque_disponivel_max.label_tag }} {{ produto_form.estoque_disponivel_max }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ produto_form.custo_unitario_min.label_tag }} {{ produto_form.custo_unitario_min }}</div>
                        <div class="col-md-6">{{ produto_form.custo_unitario_max.label_tag }} {{ produto_form.custo_unitario_max }}</div>
                    </div>
                    <div class="input-group-append mt-3">
                        <button class="btn btn-primary" type="submit">Buscar</button>
                    </div>
                </form>
                <h2>Produtos</h2>
                <table class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Estoque Disponível</th>
                            <th>Limite Estoque Baixo</th>
                            <th>Custo Unitário</th>
                            <th>Ações Disponíveis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for produto in produtos %}
                            <tr class="{% if produto in produtos_baixo_estoque %}table-danger{% endif %}">
                                <td>{{ produto.id_produto }}</td>
                                <td>{{ produto.nome }}</td>
                                <td>{{ produto.descricao|default:"Sem descrição" }}</td>
                                <td>{{ produto.estoque_disponivel }}</td>
                                <td>{{ produto.limite_estoque_baixo }}</td>
                                <td>R$ {{ produto.custo_unitario|floatformat:2 }}</td>
                                <td>
                                    <a href="/admin/fabrica/ordemproducao/add"
                                       class="btn btn-sm btn-primary">Realizar Ordem</a>
                                    <a href="/admin/fabrica/produto/{{ produto.id_produto }}/change/"
                                       class="btn btn-sm btn-secondary">Editar</a>
                                    <a href="/admin/fabrica/produto/{{ produto.id_produto }}/delete/"
                                       class="btn btn-sm btn-danger">Excluir</a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7">Nenhum produto disponível.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="materiasPrimasSection" style="display: none;">
                {% if materias_primas_baixo_estoque %}
                    <div class="alert alert-danger alert-dismissible fade show"
                         id="estoque-baixo-alerta-materias-primas"
                         role="alert">
                        <strong>Atenção!</strong> Algumas matérias-primas estão com estoque baixo:
                        <ul>
                            {% for materia in materias_primas_baixo_estoque %}
                                <li>{{ materia.nome }} - Quantidade disponível: {{ materia.estoque_disponivel }}</li>
                            {% endfor %}
                        </ul>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="alert"
                                aria-label="Close"></button>
                    </div>
                {% endif %}
                <form id="materia-prima-form"
                      method="GET"
                      action=""
                      class="mb-3 border p-3 rounded bg-secondary text-white">
                    <h2>Buscar Matérias-Primas</h2>
                    <div class="row">
                        <div class="col-md-6">{{ materia_prima_form.id_materiaprima.label_tag }} {{ materia_prima_form.id_materiaprima }}</div>
                        <div class="col-md-6">{{ materia_prima_form.nome.label_tag }} {{ materia_prima_form.nome }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ materia_prima_form.estoque_disponivel_min.label_tag }} {{ materia_prima_form.estoque_disponivel_min }}
                        </div>
                        <div class="col-md-6">
                            {{ materia_prima_form.estoque_disponivel_max.label_tag }} {{ materia_prima_form.estoque_disponivel_max }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ materia_prima_form.custo_unitario_min.label_tag }} {{ materia_prima_form.custo_unitario_min }}
                        </div>
                        <div class="col-md-6">
                            {{ materia_prima_form.custo_unitario_max.label_tag }} {{ materia_prima_form.custo_unitario_max }}
                        </div>
                    </div>
                    <div class="input-group-append mt-3">
                        <button class="btn btn-primary" type="submit">Buscar</button>
                    </div>
                </form>
                <h2>Matérias-Primas</h2>
                <table class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Estoque Disponível</th>
                            <th>Limite Estoque Baixo</th>
                            <th>Custo Unidade</th>
                            <th>Ações Disponíveis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for materia in materias_primas %}
                            <tr class="{% if materia in materias_primas_baixo_estoque %}table-danger{% endif %}">
                                <td>{{ materia.id_materiaprima }}</td>
                                <td>{{ materia.nome }}</td>
                                <td>{{ materia.estoque_disponivel }}</td>
                                <td>{{ materia.limite_estoque_baixo }}</td>
                                <td>R$ {{ materia.custo_unidade|floatformat:2 }}</td>
                                <td>
                                    <a href="/comprar_materiaprima/{{ materia.id_materiaprima }}"
                                       class="btn btn-sm btn-primary">Comprar</a>
                                    <a href="/admin/fabrica/materiaprima/{{ materia.id_materiaprima }}/change/"
                                       class="btn btn-sm btn-secondary">Editar</a>
                                    <a href="/admin/fabrica/materiaprima/{{ materia.id_materiaprima }}/delete/"
                                       class="btn btn-sm btn-danger">Excluir</a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6">Nenhuma matéria-prima disponível.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleProdutos = document.getElementById('toggleProdutos');
            const toggleMateriasPrimas = document.getElementById('toggleMateriasPrimas');
            const produtosSection = document.getElementById('produtosSection');
            const materiasPrimasSection = document.getElementById('materiasPrimasSection');
            const addProdutoButton = document.getElementById('addProdutoButton');
            const addMateriaPrimaButton = document.getElementById('addMateriaPrimaButton');
            const produtoForm = document.getElementById('produto-form');
            const materiaPrimaForm = document.getElementById('materia-prima-form');

            const toggleProdutosState = localStorage.getItem('toggleProdutos');
            const toggleMateriasPrimasState = localStorage.getItem('toggleMateriasPrimas');

            if (toggleProdutosState === 'true' || toggleProdutosState === null) {
                addProdutoButton.style.display = 'block';
                addMateriaPrimaButton.style.display = 'none';
                toggleProdutos.checked = true;
                produtosSection.style.display = 'block';
                toggleMateriasPrimas.checked = false;
                materiasPrimasSection.style.display = 'none';
            }

            if (toggleMateriasPrimasState === 'true') {
                addMateriaPrimaButton.style.display = 'block';
                addProdutoButton.style.display = 'none';
                toggleMateriasPrimas.checked = true;
                materiasPrimasSection.style.display = 'block';
                toggleProdutos.checked = false;
                produtosSection.style.display = 'none';
            }

            toggleProdutos.addEventListener('change', function () {
                if (this.checked) {
                    produtosSection.style.display = 'block';
                    addProdutoButton.style.display = 'block';
                    addMateriaPrimaButton.style.display = 'none';
                    toggleMateriasPrimas.checked = false;
                    materiasPrimasSection.style.display = 'none';
                    localStorage.setItem('toggleProdutos', 'true');
                    localStorage.setItem('toggleMateriasPrimas', 'false');
                } else {
                    produtosSection.style.display = 'none';
                    addProdutoButton.style.display = 'none';
                    localStorage.setItem('toggleProdutos', 'false');
                }
            });

            toggleMateriasPrimas.addEventListener('change', function () {
                if (this.checked) {
                    materiasPrimasSection.style.display = 'block';
                    addMateriaPrimaButton.style.display = 'block';
                    addProdutoButton.style.display = 'none';
                    toggleProdutos.checked = false;
                    produtosSection.style.display = 'none';
                    localStorage.setItem('toggleMateriasPrimas', 'true');
                    localStorage.setItem('toggleProdutos', 'false');
                } else {
                    materiasPrimasSection.style.display = 'none';
                    addMateriaPrimaButton.style.display = 'none';
                    localStorage.setItem('toggleMateriasPrimas', 'false');
                }
            });
        });
        </script>
        <script src="{% static 'bootstrap.bundle.js' %}"></script>
    </body>
    {% include "footer.html" %}
</html>
